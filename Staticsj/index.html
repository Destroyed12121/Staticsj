<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>Browser123</title>
        <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
        <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
        <style>
            :root {
                --bg: #121212;
                --button-bg: #252526;
                --button-hover: #3E3E42;
                --third-bg: #333333;
                --text-color: #EAEAEA;
                --secondary-text-color: #9E9E9E;
                --primary: #5591F5;
            }

            body, html, #app {
                font-family: "Inter", system-ui, sans-serif;
                width: 100vw;
                height: 100vh;
                margin: 0;
                background: var(--bg);
                overflow: hidden;
            }

            .flex {
                display: flex;
            }

            .browser-container {
                width: 100%;
                height: 100%;
                color: var(--text-color);
                display: flex;
                flex-direction: column;
            }

            .browser-container iframe {
                background-color: #fff;
                border: none;
                flex: 1;
                width: 100%;
            }

            input.bar {
                font-family: "Inter";
                padding: 0.6rem 1rem;
                border: none;
                outline: none;
                color: var(--text-color);
                border-radius: 8px;
                flex: 1;
                background: var(--button-bg);
                font-size: 1.1rem;
                transition: 0.2s ease;
            }

            input.bar:focus {
                background-color: var(--button-hover);
            }

            .nav {
                padding: 0.6rem;
                gap: 0.5rem;
            }

            .nav button {
                color: var(--text-color);
                outline: none;
                border: none;
                border-radius: 8px;
                background: var(--button-bg);
                padding: 0.6rem 1rem;
                cursor: pointer;
                transition: 0.2s ease;
                font-size: 1.1rem;
            }

            .nav button:hover {
                background-color: var(--button-hover);
            }

            .tabs {
                padding: 0.6rem 0.6rem 0;
                gap: 0.3rem;
                overflow-x: auto;
                white-space: nowrap;
            }

            .tabs::-webkit-scrollbar {
                height: 4px;
            }

            .tabs::-webkit-scrollbar-track {
                background: transparent;
            }

            .tabs::-webkit-scrollbar-thumb {
                background: var(--third-bg);
                border-radius: 2px;
            }

            .tab {
                color: var(--text-color);
                outline: none;
                border: none;
                border-radius: 8px 8px 0 0;
                background: var(--button-bg);
                padding: 0.5rem 1rem;
                width: 245px;
                min-width: 245px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                display: flex;
                align-items: center;
                gap: 0.6rem;
                cursor: pointer;
                flex-shrink: 0;
                transition: 0.2s ease;
                font-size: 1rem;
            }

            .tab.active {
                background-color: var(--button-hover);
            }

            .tab:hover:not(.active) {
                background-color: var(--third-bg);
            }

            .tab-favicon {
                width: 18px;
                height: 18px;
                flex-shrink: 0;
                border-radius: 4px;
            }

            .tab-title {
                flex: 1;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .tab-close {
                background: none;
                border: none;
                color: var(--secondary-text-color);
                cursor: pointer;
                padding: 0;
                width: 20px;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 4px;
                flex-shrink: 0;
                transition: 0.2s ease;
                font-size: 1.2rem;
            }

            .tab-close:hover {
                background-color: var(--third-bg);
                color: var(--text-color);
            }

            .new-tab {
                color: var(--text-color);
                outline: none;
                border: none;
                border-radius: 8px;
                background: var(--button-bg);
                padding: 0.7rem;
                cursor: pointer;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
                transition: 0.2s ease;
                font-size: 1.3rem;
            }

            .new-tab:hover {
                background-color: var(--button-hover);
            }

            .iframe-container {
                flex: 1;
                position: relative;
            }

            .iframe-container iframe {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }

            .iframe-container iframe.hidden {
                display: none;
            }

            .sortable-ghost {
                opacity: 0.5 !important;
            }

            .sortable-drag {
                transform: rotate(2deg);
            }
        </style>
        <script src="JS/scramjet.all.js"></script>
        <script src="B/index.js"></script>
        <script src="prxxry.config.js"></script>
    </head>
    <body>
        <div id="app"></div>
        <script>
            const currentPath = window.location.pathname;
            const basePath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1);

            const {ScramjetController} = $scramjetLoadController();

            // Configure Scramjet controller with the correct prefix
            const scramjet = new ScramjetController({
                // ===================================================================
                // FIX: Add this line to match the service worker's prefix
                prefix: `${basePath}scramjet/`,
                // ===================================================================
                files: {
                    wasm: `${basePath}JS/scramjet.wasm.wasm`,
                    all: `${basePath}JS/scramjet.all.js`,
                    sync: `${basePath}JS/scramjet.sync.js`,
                },
            });

            scramjet.init();
            navigator.serviceWorker.register(`${basePath}sw.js`);

            const connection = new BareMux.BareMuxConnection(`${basePath}B/worker.js`);
            const store = {
                url: "https://",
                wispurl: localStorage.getItem("proxServer") || _CONFIG.wispurl,
                bareurl: _CONFIG?.bareurl || (location.protocol === "https:" ? "https" : "http") + "://" + location.host + "/bare/",
                proxy: ""
            };
            connection.setTransport(`${basePath}Ep/index.mjs`, [{
                wisp: store.wispurl
            }]);

            let tabs = [];
            let activeTabId = null;
            let nextTabId = 1;
            let sortableInstance = null;

            function createTab(makeActive=true) {
                const frame = scramjet.createFrame();
                const tab = {
                    id: nextTabId++,
                    title: "New Tab",
                    url: "",
                    frame: frame,
                    favicon: "https://duckduckgo.com/favicon.ico"
                };

                frame.frame.src = `${basePath}NT.html`;

                frame.addEventListener("urlchange", (e) => {
                    if (!e.url || e.url === "about:blank")
                        return;
                    tab.url = e.url;
                    try {
                        tab.favicon = new URL(e.url).origin + '/favicon.ico';
                    } catch (e) {/* ignore */
                    }
                    try {
                        tab.title = frame.frame.contentWindow.document.title || new URL(e.url).hostname;
                    } catch (e) {
                        tab.title = new URL(e.url).hostname;
                    }
                    updateTabsUI();
                    updateAddressBar();
                }
                );
                frame.frame.addEventListener('load', () => {
                    try {
                        const newTitle = frame.frame.contentWindow.document.title;
                        if (newTitle && tab.title !== newTitle) {
                            tab.title = newTitle;
                            updateTabsUI();
                        }
                    } catch (e) {/* Ignore */
                    }
                }
                );
                tabs.push(tab);
                if (makeActive) {
                    activeTabId = tab.id;
                }
                return tab;
            }

            function getActiveTab() {
                return tabs.find( (tab) => tab.id === activeTabId);
            }
            function switchTab(tabId) {
                if (activeTabId === tabId)
                    return;
                tabs.forEach( (tab) => tab.frame.frame.classList.add("hidden"));
                activeTabId = tabId;
                const activeTab = getActiveTab();
                if (activeTab) {
                    activeTab.frame.frame.classList.remove("hidden");
                }
                updateTabsUI();
                updateAddressBar();
            }
            function closeTab(tabId) {
                const tabIndex = tabs.findIndex( (tab) => tab.id === tabId);
                if (tabIndex === -1)
                    return;
                const tabToRemove = tabs[tabIndex];
                if (tabToRemove.frame.frame.parentNode) {
                    tabToRemove.frame.frame.parentNode.removeChild(tabToRemove.frame.frame);
                }
                tabs.splice(tabIndex, 1);
                if (activeTabId === tabId) {
                    if (tabs.length > 0) {
                        const newActiveIndex = Math.min(tabIndex, tabs.length - 1);
                        switchTab(tabs[newActiveIndex].id);
                    } else {
                        activeTabId = null;
                        const newTab = createTab(true);
                        document.getElementById("iframe-container").appendChild(newTab.frame.frame);
                    }
                }
                updateTabsUI();
                updateAddressBar();
            }
            function updateTabsUI() {
                const tabsContainer = document.getElementById("tabs-container");
                if (!tabsContainer)
                    return;
                const newTabButton = tabsContainer.querySelector('.new-tab');
                if (newTabButton)
                    newTabButton.remove();
                tabsContainer.innerHTML = "";
                tabs.forEach( (tab) => {
                    const tabElement = document.createElement("div");
                    tabElement.className = `tab ${tab.id === activeTabId ? "active" : ""}`;
                    tabElement.setAttribute("data-tab-id", tab.id);
                    tabElement.onclick = () => switchTab(tab.id);
                    const faviconImg = document.createElement("img");
                    faviconImg.className = "tab-favicon";
                    faviconImg.src = tab.favicon;
                    faviconImg.onerror = () => {
                        faviconImg.src = "about:blank";
                    }
                    ;
                    const titleSpan = document.createElement("span");
                    titleSpan.className = "tab-title";
                    titleSpan.textContent = tab.title;
                    const closeButton = document.createElement("button");
                    closeButton.className = "tab-close";
                    closeButton.innerHTML = "&times;";
                    closeButton.onclick = (e) => {
                        e.stopPropagation();
                        closeTab(tab.id);
                    }
                    ;
                    tabElement.appendChild(faviconImg);
                    tabElement.appendChild(titleSpan);
                    tabElement.appendChild(closeButton);
                    tabsContainer.appendChild(tabElement);
                }
                );
                const newBtn = document.createElement("button");
                newBtn.className = "new-tab";
                newBtn.textContent = "+";
                newBtn.onclick = () => {
                    const newTab = createTab(false);
                    document.getElementById("iframe-container").appendChild(newTab.frame.frame);
                    switchTab(newTab.id);
                }
                ;
                tabsContainer.appendChild(newBtn);
                if (sortableInstance) {
                    sortableInstance.destroy();
                }
                sortableInstance = new Sortable(tabsContainer,{
                    animation: 200,
                    direction: "horizontal",
                    ghostClass: "sortable-ghost",
                    dragClass: "sortable-drag",
                    filter: ".new-tab",
                    onEnd: (evt) => {
                        if (evt.oldIndex !== evt.newIndex) {
                            const movedTab = tabs.splice(evt.oldIndex, 1)[0];
                            tabs.splice(evt.newIndex, 0, movedTab);
                        }
                    }
                });
            }
            function updateAddressBar() {
                const addressBar = document.getElementById("address-bar");
                const activeTab = getActiveTab();
                if (addressBar) {
                    addressBar.value = activeTab ? activeTab.url : "";
                }
            }
            function handleSubmit() {
                const activeTab = getActiveTab();
                const addressBar = document.getElementById("address-bar");
                if (!activeTab || !addressBar)
                    return;
                let url = addressBar.value.trim();
                if (url === "")
                    return;
                try {
                    new URL(url);
                } catch {
                    url = !url.includes("://") && url.includes(".") ? "https://" + url : "https://duckduckgo.com/?q=" + encodeURIComponent(url);
                }
                activeTab.frame.go(url);
            }
            function toggleDevTools() {
                const activeTab = getActiveTab();
                if (!activeTab)
                    return;
                const frameWindow = activeTab.frame.frame.contentWindow;
                if (!frameWindow)
                    return;
                if (frameWindow.eruda) {
                    frameWindow.eruda.destroy();
                    delete frameWindow.eruda;
                } else {
                    let script = frameWindow.document.createElement('script');
                    script.src = "https://cdn.jsdelivr.net/npm/eruda";
                    script.onload = function() {
                        frameWindow.eruda.init();
                        frameWindow.eruda.show();
                    }
                    ;
                    frameWindow.document.body.appendChild(script);
                }
            }
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'navigate' && event.data.url) {
                    getActiveTab()?.frame.go(event.data.url);
                }
            }
            );
            window.addEventListener("load", async () => {
                root.innerHTML = `<div class="browser-container"><div class="flex tabs" id="tabs-container"></div><div class="flex nav"><button id="back-btn"><i class="fa-solid fa-chevron-left"></i></button><button id="fwd-btn"><i class="fa-solid fa-chevron-right"></i></button><button id="reload-btn"><i class="fa-solid fa-rotate-right"></i></button><input class="bar" id="address-bar" autocomplete="off" autocapitalize="off" autocorrect="off"><button id="devtools-btn"><i class="fa-solid fa-code"></i></button><button id="open-new-window-btn"><i class="fa-solid fa-arrow-up-right-from-square"></i></button></div><div class="iframe-container" id="iframe-container"></div></div>`;
                document.getElementById('back-btn').onclick = () => getActiveTab()?.frame.back();
                document.getElementById('fwd-btn').onclick = () => getActiveTab()?.frame.forward();
                document.getElementById('reload-btn').onclick = () => getActiveTab()?.frame.reload();
                document.getElementById('address-bar').onkeyup = (event) => {
                    if (event.keyCode === 13)
                        handleSubmit();
                }
                ;
                document.getElementById('open-new-window-btn').onclick = () => {
                    const url = getActiveTab()?.url;
                    if (url)
                        window.open(scramjet.encodeUrl(url));
                }
                ;
                document.getElementById('devtools-btn').onclick = toggleDevTools;
                const initialTab = createTab(true);
                document.getElementById("iframe-container").appendChild(initialTab.frame.frame);
                updateTabsUI();
                updateAddressBar();
            }
            );
            const root = document.getElementById("app");
        </script>
    </body>
</html>
