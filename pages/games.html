<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Games - Unblockee</title>

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts for Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Shared CSS -->
    <link rel="stylesheet" href="../../all.css">

    <!-- Page-specific styles -->
    <style>
        .hero-section {
            padding: var(--padding-xxl) var(--padding-xl) var(--padding-xl);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--gap-md);
        }

        .nav-buttons {
            display: flex;
            gap: var(--gap-sm);
            flex-wrap: wrap;
            justify-content: center;
            margin-top: var(--margin-xl);
        }

        .nav-btn {
            background: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            color: var(--text-primary);
            cursor: pointer;
            padding: var(--padding-sm) var(--padding-md);
            font-size: var(--font-size-xs);
            transition: all var(--transition-speed);
            display: flex;
            align-items: center;
            gap: var(--gap-xs);
        }

        .nav-btn:hover {
            background: var(--border-color);
            transform: translateY(-1px);
        }
        #header h1 {
            font-size: var(--font-size-xxl);
            font-weight: 600;
            animation: fadeIn 1s ease-in-out;
        }
        #header p {
            font-size: var(--font-size-md);
            color: var(--text-secondary);
            min-height: clamp(20px, 3vh, 24px); /* Prevents layout shift */
            animation: fadeIn 1s ease-in-out 0.2s backwards;
        }
        .controls-container {
            display: flex;
            align-items: center;
            background: var(--search-bar-color);
            padding: var(--padding-sm) var(--padding-md);
            border-radius: clamp(1rem, 4vw, 2rem);
            box-shadow: 0 clamp(3px, 1vh, 6px) clamp(15px, 5vh, 30px) rgba(0,0,0,0.7);
            animation: popIn 0.6s ease;
            width: 100%;
            max-width: clamp(300px, 80vw, 550px);
            border: 1px solid var(--border-color);
        }
        #searchBar {
            flex: 1;
            background: none;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: var(--font-size-sm);
            padding: var(--padding-xs);
        }
        #sortOptions {
            background: var(--card-color);
            border: none;
            color: var(--text-primary);
            border-radius: var(--border-radius-sm);
            padding: var(--padding-xs) var(--padding-sm);
            margin-left: var(--margin-sm);
            cursor: pointer;
            transition: background .2s;
        }
        #sortOptions:hover { background: #2a2a2a; }

        /* --- GAME GRID --- */
        .container {
            max-width: clamp(800px, 95vw, 1600px);
            margin: 0 auto;
            padding: var(--padding-xl);
        }
        #container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(var(--game-card-min-size), 1fr));
            grid-template-columns: repeat(auto-fit, minmax(var(--game-card-min-size), 1fr));
            gap: var(--gap-lg);
        }

        /* --- MINIMALIST GAME CARDS (LIKE ICONS) --- */
        .game-card {
            background-color: var(--card-color);
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: 0 var(--padding-xs) clamp(5px, 1vw, 10px) rgba(0,0,0,0.5);
            transition: all 0.25s ease;
            aspect-ratio: 1 / 1; /* Makes them perfect squares */
        }
        .game-card:hover {
            transform: translateY(-4px) scale(1.05);
            background: #2a2a2a;
        }
        .game-cover {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
        }
        .game-title {
            position: absolute;
            bottom: var(--padding-sm);
            left: 0;
            right: 0;
            font-size: var(--font-size-xs);
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 var(--padding-xs);
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }

        /* --- FONT AWESOME STAR ICON --- */
        .star-icon {
            position: absolute;
            top: var(--padding-sm);
            right: var(--padding-sm);
            z-index: 2;
            color: white;
            cursor: pointer;
            font-size: var(--icon-size-md);
            opacity: 0.8;
            transition: all 0.2s;
            text-shadow: 0 1px 2px rgba(0,0,0,0.7);
        }
        .star-icon:hover {
            opacity: 1;
            transform: scale(1.15);
        }
        .favorited {
            color: gold !important;
            opacity: 1 !important;
        }

        /* --- ANIMATIONS FROM YOUR EXAMPLE --- */
        @keyframes fadeIn {
            from {opacity: 0; transform: translateY(-10px);}
            to {opacity: 1; transform: translateY(0);}
        }
        @keyframes popIn {
            0% {transform: scale(0.8); opacity: 0;}
            100% {transform: scale(1); opacity: 1;}
        }
    </style>

    <!-- Scripts -->
    <script src="../../effects.js" defer></script>
    <script src="../../pluginstuff.js" defer></script>
</head>
<body>
    <!-- Modal for game viewing -->
    <div id="gameModal" class="modal-overlay hidden">
        <div class="modal-container">
            <div class="modal-header">
                <h2 id="gameModalTitle">Game Title</h2>
                <button class="modal-close-btn" onclick="closeGameModal()">&times;</button>
            </div>
            <div class="modal-body">
                <iframe id="gameFrame" allowfullscreen></iframe>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="fullscreenGame()">Fullscreen</button>
                <button class="btn" onclick="openGameInAboutBlank()">Open in about:blank</button>
            </div>
        </div>
    </div>

    <div class="hero-section">
        <div id="header">
            <h1>Games</h1>
            <p id="subtitle">Loading a fun fact...</p>
            <div class="nav-buttons">
                <button class="nav-btn" onclick="navigateTo('./movies.html')">
                    <i class="fas fa-film"></i> Movies
                </button>
                <button class="nav-btn" onclick="navigateTo('./music.html')">
                    <i class="fas fa-music"></i> Music
                </button>
                <button class="nav-btn" onclick="navigateTo('../Staticsj/index.html')">
                    <i class="fas fa-globe"></i> Browser
                </button>
                <button class="nav-btn" onclick="navigateTo('../index.html')">
                    <i class="fas fa-home"></i> Home
                </button>
            </div>
        </div>
        <div class="controls-container">
            <input type="text" id="searchBar" placeholder="Search games..." oninput="filterZones()">
            <select id="sortOptions" onchange="sortZones()">
                <option value="popular">Popular</option>
                <option value="name">Name</option>
                <option value="id">Newest</option>
            </select>
        </div>
    </div>

    <main class="container">
        <div id="container">
            <p style="text-align:center; grid-column: 1 / -1;">Loading games...</p>
        </div>
    </main>

    <script>
    const container = document.getElementById('container');
    const gameModal = document.getElementById('gameModal');
    const gameFrame = document.getElementById('gameFrame');
    const gameModalTitle = document.getElementById('gameModalTitle');
    const searchBar = document.getElementById('searchBar');
    const sortOptions = document.getElementById('sortOptions');
    const subtitleElement = document.getElementById('subtitle');

    const zonesurls = ["https://cdn.jsdelivr.net/gh/gn-math/assets@latest/zones.json"];
    let zonesURL = zonesurls[0];
    const coverURL = "https://cdn.jsdelivr.net/gh/gn-math/covers@main";
    const htmlURL = "https://cdn.jsdelivr.net/gh/gn-math/html@main";
    let zones = [];
    let popularityData = {};
    let currentGameUrl = null;

    const quotes = [
      "\"Code is like humor. When you have to explain it, it's bad.\"", "\"Programs must be written for people to read.\"",  "\"Dark mode saves eyes, trust the process.\"", "\"When in doubt, console.log it.\"", "\"It's not a bug, it's an undocumented feature.\"", "\"Have you tried turning it off and on again?\"", "\"The only way to do great work is to love what you do.\"", "\"The journey of a thousand miles begins with a single step.\"", "\"Strive not to be a success, but rather to be of value.\"", "\"Believe you can and you're halfway there.\"", "\"The future belongs to those who believe in the beauty of their dreams.\"", "\"The best time to plant a tree was 20 years ago. The second best time is now.\"", "\"You must be the change you wish to see in the world.\"", "\"In three words I can sum up everything I've learned about life: it goes on.\"", "\"The only thing we have to fear is fear itself.\"", "\"To be yourself in a world that is constantly trying to make you something else is the greatest accomplishment.\"", "\"The mind is everything. What you think you become.\"", "\"The greatest glory in living lies not in never falling, but in rising every time we fall.\"", "\"Life is what happens when you're busy making other plans.\"", "\"That which does not kill us makes us stronger.\"", "\"The only true wisdom is in knowing you know nothing.\"", "\"It does not matter how slowly you go as long as you do not stop.\"", "\"Success is not final, failure is not fatal: it is the courage to continue that counts.\"", "\"Dream big and dare to fail.\"", "\"Act as if what you do makes a difference. It does.\"", "\"The only impossible journey is the one you never begin.\""
    ];

    const urlOverrides = {
        "1v1.lol": "https://1v1lol33.surge.sh",
        "speed stars": "https://speedstar11.surge.sh"
    };

    function setRandomQuote() {
        subtitleElement.textContent = quotes[Math.floor(Math.random() * quotes.length)];
    }

    function getFavorites() {
        return JSON.parse(localStorage.getItem('favoriteGames') || '[]');
    }
    function saveFavorites(favs) {
        localStorage.setItem('favoriteGames', JSON.stringify(favs));
    }

    async function listZones() {
        try {
            let commitResponse = await fetch("https://api.github.com/repos/gn-math/assets/commits?t=" + Date.now());
            if (commitResponse && commitResponse.status === 200) {
                let sha = (await commitResponse.json())[0]['sha'];
                if (sha) zonesURL = `https://cdn.jsdelivr.net/gh/gn-math/assets@${sha}/zones.json`;
            }

            const response = await fetch(zonesURL + "?t=" + Date.now());
            zones = await response.json();

            await fetchPopularity();
            sortZones();

        } catch (error) {
            console.error(error);
            container.innerHTML = `<p style="color: red; text-align:center; grid-column: 1 / -1;">Error loading games. The source may be down.</p>`;
        }
    }

    async function fetchPopularity() {
        try {
            const response = await fetch("https://data.jsdelivr.com/v1/stats/packages/gh/gn-math/html@main/files?period=year");
            const data = await response.json();
            data.forEach(file => {
                const idMatch = file.name.match(/\/(\d+)\.html$/);
                if (idMatch) popularityData[parseInt(idMatch[1])] = file.hits.total;
            });
        } catch (error) {
            console.error('Failed to fetch popularity data:', error);
        }
    }

    function sortZones() {
        const sortBy = sortOptions.value;
        const favorites = getFavorites();
        zones.sort((a, b) => {
            const isAFavorite = favorites.includes(a.id.toString());
            const isBFavorite = favorites.includes(b.id.toString());
            if (isAFavorite && !isBFavorite) return -1;
            if (!isAFavorite && isBFavorite) return 1;

            if (sortBy === 'name') return a.name.localeCompare(b.name);
            if (sortBy === 'id') return b.id - a.id;
            return (popularityData[b.id] || 0) - (popularityData[a.id] || 0);
        });
        displayZones(zones);
    }

    function displayZones(zonesToDisplay) {
        container.innerHTML = "";
        const favorites = getFavorites();

        zonesToDisplay.forEach(file => {
            const card = document.createElement('div');
            card.className = 'game-card';
            card.onclick = () => openGameModal(file);

            const star = document.createElement('i');
            const isFavorited = favorites.includes(file.id.toString());
            star.className = `star-icon fa-star ${isFavorited ? 'fa-solid favorited' : 'fa-regular'}`;
            star.onclick = (event) => toggleFavorite(event, file.id.toString());

            const cover = document.createElement('div');
            cover.className = 'game-cover lazy-cover';
            cover.dataset.src = file.cover.replace("{COVER_URL}", coverURL);

            const title = document.createElement('div');
            title.className = 'game-title';
            title.textContent = file.name;

            card.appendChild(star);
            card.appendChild(cover);
            card.appendChild(title);
            container.appendChild(card);
        });

        lazyLoadImages();
    }

    function toggleFavorite(event, gameId) {
        if (event) event.stopPropagation();
        let favorites = getFavorites();
        const index = favorites.indexOf(gameId);
        if (index > -1) {
            favorites.splice(index, 1);
        } else {
            favorites.push(gameId);
        }
        saveFavorites(favorites);
        sortZones();
    }

    function filterZones() {
        const query = searchBar.value.toLowerCase();
        displayZones(zones.filter(zone => zone.name.toLowerCase().includes(query)));
    }

    function lazyLoadImages() {
        const lazyImages = document.querySelectorAll('.lazy-cover');
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const cover = entry.target;
                    cover.style.backgroundImage = `url('${cover.dataset.src}')`;
                    observer.unobserve(cover);
                }
            });
        });
        lazyImages.forEach(img => imageObserver.observe(img));
    }

    function openGameModal(file) {
        gameModalTitle.textContent = file.name;
        gameModal.classList.remove('hidden');
        document.body.classList.add('modal-open');

        const gameNameLower = file.name.toLowerCase();
        if (urlOverrides[gameNameLower]) {
            const overrideUrl = urlOverrides[gameNameLower];
            gameFrame.src = overrideUrl;
            currentGameUrl = overrideUrl;
            return;
        }

        if (file.url.startsWith("http")) {
            gameFrame.src = file.url;
            currentGameUrl = file.url;
            return;
        }
        const url = file.url.replace("{HTML_URL}", htmlURL);
        currentGameUrl = url;

        gameFrame.src = "about:blank";

        fetch(url + "?t=" + Date.now())
            .then(response => response.text())
            .then(html => {
                const blob = new Blob([html], { type: 'text/html' });
                const blobUrl = URL.createObjectURL(blob);
                gameFrame.src = blobUrl;
                currentGameUrl = blobUrl;
            }).catch(error => alert("Failed to load game: " + error));
    }

    function closeGameModal() {
        gameModal.classList.add('hidden');
        document.body.classList.remove('modal-open');
        if (currentGameUrl && currentGameUrl.startsWith('blob:')) {
            URL.revokeObjectURL(currentGameUrl);
        }
        currentGameUrl = null;
        gameFrame.src = '';
    }

    function fullscreenGame() {
        if (gameFrame.requestFullscreen) {
            gameFrame.requestFullscreen();
        } else if (gameFrame.webkitRequestFullscreen) {
            gameFrame.webkitRequestFullscreen();
        } else if (gameFrame.msRequestFullscreen) {
            gameFrame.msRequestFullscreen();
        }
    }

    function openGameInAboutBlank() {
        if (currentGameUrl) {
            window.openURLInAboutBlank(currentGameUrl);
        }
    }

    const schoolList = ["deledao", "goguardian", "lightspeed", "linewize", "securly", ".edu/"];
    function isBlockedDomain(url) {
        if (!url) return false;
        try {
            const domain = new URL(url, location.origin).hostname + "/";
            return schoolList.some(school => domain.includes(school));
        } catch (e) { return false; }
    }
    const originalFetch = window.fetch;
    window.fetch = function (url, options) {
        if (isBlockedDomain(url)) return Promise.reject(new Error("Request blocked."));
        return originalFetch.apply(this, arguments);
    };

    // --- INITIALIZE APP ---
    setRandomQuote();
    listZones();

    // Navigation function
    function navigateTo(url) {
        console.log('Navigating to:', url);
        window.location.href = url;
    }
    </script>
</body>
</html>